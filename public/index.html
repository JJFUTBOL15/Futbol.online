<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agenda - JJFUTBOL</title>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #0f0f15; color: white; padding: 20px; }
    #agenda-titulo { font-size: 1.6em; margin-bottom: 20px; color: #D4AF37; text-align: center; }
    .evento-contenedor { margin-bottom: 15px; border-bottom: 1px solid #222; }
    .evento { display: flex; align-items: center; padding: 12px 0; cursor: pointer; }
    .hora { width: 60px; background: #1e3a8a; color: white; padding: 4px 8px; border-radius: 12px; font-weight: bold; text-align: center; }
    .evento-icono { width: 24px; height: 24px; border-radius: 50%; margin: 0 10px; }
    .info-evento { flex: 1; }
    .flecha { color: #666; font-size: 1.5em; }
    .canales { display: none; padding: 10px 0 10px 80px; }
    .canal-link { display: block; color: #4ade80; text-decoration: none; margin: 6px 0; }
    .canal-link:hover { text-decoration: underline; }
    .sin-canales { color: #888; }
    .error { color: red; text-align: center; padding: 20px; }
  </style>
</head>
<body>
  <h1 id="agenda-titulo">Cargando agenda...</h1>
  <div id="agenda-lista"></div>

  <script>
    $(document).ready(function() {
      const AGENDA_URL = "https://golazoplay.com/agenda.json"; // ✅ sin espacios
      const agendaLista = $('#agenda-lista');
      const tituloAgenda = $('#agenda-titulo');

      function convertirHora(utcHour) {
        if (!utcHour) return "--:--";
        try {
          const limpia = utcHour.split(':').slice(0, 2).join(':');
          const dt = luxon.DateTime.fromFormat(limpia, "HH:mm", { zone: "America/Lima" });
          return dt.toLocal().toFormat("HH:mm");
        } catch (e) {
          return "--:--";
        }
      }

      async function cargarAgenda() {
        try {
          const respuesta = await fetch(AGENDA_URL + "?t=" + new Date().getTime());
          const json = await respuesta.json();
          const eventos = json.data || [];

          agendaLista.empty();
          const hoy = new Date();
          tituloAgenda.text('AGENDA - ' + hoy.getDate() + ' DE ' + hoy.toLocaleString('es-ES', { month: 'long' }).toUpperCase() + ' DE ' + hoy.getFullYear());

          if (eventos.length === 0) {
            agendaLista.html('<p class="error">No hay eventos programados para hoy.</p>');
            return;
          }

          eventos.sort((a, b) => a.attributes.diary_hour?.localeCompare(b.attributes.diary_hour));

          eventos.forEach(evento => {
            const attr = evento.attributes || {};
            const horaLocal = convertirHora(attr.diary_hour);
            const titulo = attr.diary_description || "Evento sin nombre";

            let urlIcono = "https://i.imgur.com/Vdef5Rz.png";
            if (attr.country?.data?.attributes?.image?.data?.attributes?.url) {
              urlIcono = "https://img.golazoplay.com" + attr.country.data.attributes.image.data.attributes.url;
            }

            let canalesHtml = '<div class="canales">';
            if (attr.embeds?.data?.length > 0) {
              attr.embeds.data.forEach(embed => {
                const nombreCanal = embed.attributes?.embed_name || "Canal";
                const urlRelativaConParametro = (embed.attributes?.embed_iframe || "").trim();

                try {
                  // ✅ Extraer SOLO el parámetro "r"
                  const partes = urlRelativaConParametro.split('?');
                  if (partes.length > 1) {
                    const params = new URLSearchParams(partes[1]);
                    const urlRealCodificada = params.get("r");
                    if (urlRealCodificada) {
                      canalesHtml += `<a href="/embed/eventos.html?r=${encodeURIComponent(urlRealCodificada)}" target="_blank" class="canal-link">➤ ${nombreCanal}</a>`;
                    } else {
                      canalesHtml += `<span class="sin-canales">${nombreCanal} (No disponible)</span>`;
                    }
                  } else {
                    canalesHtml += `<span class="sin-canales">${nombreCanal} (URL inválida)</span>`;
                  }
                } catch (e) {
                  console.error("Error parseando URL:", urlRelativaConParametro, e);
                  canalesHtml += `<span class="sin-canales">${nombreCanal} (Error)</span>`;
                }
              });
            } else {
              canalesHtml += `<span class="sin-canales">Próximamente...</span>`;
            }
            canalesHtml += '</div>';

            const eventoHtml = `
              <div class="evento-contenedor">
                <div class="evento">
                  <div class="hora">${horaLocal}</div>
                  <img src="${urlIcono}" class="evento-icono" alt="">
                  <div class="info-evento">${titulo}</div>
                  <div class="flecha">›</div>
                </div>
                ${canalesHtml}
              </div>
            `;
            agendaLista.append(eventoHtml);
          });

        } catch (error) {
          console.error("Error al cargar la agenda:", error);
          agendaLista.html('<p class="error">No se pudo cargar la agenda.</p>');
        }
      }

      agendaLista.on('click', '.evento', function() {
        const subMenu = $(this).siblings('.canales');
        $('.canales').not(subMenu).slideUp('fast');
        subMenu.slideToggle('fast');
      });

      cargarAgenda();
      setInterval(cargarAgenda, 60000);
    });
  </script>
</body>
</html>
