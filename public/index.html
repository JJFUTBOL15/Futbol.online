<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agenda - JJFUTBOL</title>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #0f0f15; color: white; padding: 20px; }
    .titulo { font-size: 1.6em; margin-bottom: 20px; color: #D4AF37; }
    .evento { list-style: none; border-bottom: 1px solid #222; padding: 14px 0; }
    .fila { display: flex; align-items: center; gap: 12px; }
    .hora { background: #1e3a8a; color: white; padding: 4px 12px; border-radius: 14px; font-weight: bold; }
    .bandera { width: 20px; height: 20px; border-radius: 50%; }
    .nombre { flex: 1; }
    .servidores { display: none; padding-left: 40px; margin-top: 10px; }
    .servidores.activo { display: block; }
    .canal { display: block; color: #4ade80; text-decoration: none; margin: 6px 0; }
  </style>
</head>
<body>
  <h1 class="titulo">Agenda - Cargando...</h1>
  <ul id="eventos"></ul>

  <script>
    // ✅ Fuente de datos
    const FUENTE = "https://golazoplay.com/agenda.json?v=1.0";

    document.addEventListener("DOMContentLoaded", () => {
      cargarAgenda();
      setInterval(cargarAgenda, 60000);
    });

    document.addEventListener("click", (e) => {
      const ev = e.target.closest(".evento");
      if (!ev) return;
      document.querySelectorAll(".servidores").forEach(el => el.classList.remove("activo"));
      const s = ev.querySelector(".servidores");
      if (s && !s.classList.contains("activo")) s.classList.add("activo");
    });

    function convertirHora(horaLima) {
      if (!horaLima) return "--:--";
      try {
        const limpia = horaLima.split(':').slice(0, 2).join(':');
        const dt = luxon.DateTime.fromFormat(limpia, "HH:mm", { zone: "America/Lima" });
        return dt.toLocal().toFormat("HH:mm");
      } catch (e) {
        return "--:--";
      }
    }

    async function cargarAgenda() {
      const cont = document.getElementById("eventos");
      const tit = document.querySelector(".titulo");

      try {
        const res = await fetch(FUENTE);
        const data = await res.json();

        if (!data?.data?.length) {
          cont.innerHTML = "<li style='color:red;'>Sin eventos disponibles.</li>";
          tit.textContent = "Agenda - Sin datos";
          return;
        }

        const hoy = new Date().toLocaleDateString("es-ES", {
          year: "numeric", month: "long", day: "numeric"
        });
        tit.textContent = "Agenda - " + hoy;

        data.data.sort((a, b) => 
          a.attributes.diary_hour?.localeCompare(b.attributes.diary_hour)
        );

        let html = "";
        data.data.forEach(item => {
          const attr = item.attributes || {};
          const hora = convertirHora(attr.diary_hour);
          const nombre = attr.diary_description?.trim() || "Evento sin nombre";
          const logo = attr.country?.data?.attributes?.image?.data?.attributes?.url
            ? "https://img.futbolonlinehd.com" + attr.country.data.attributes.image.data.attributes.url
            : "https://img.futbolonlinehd.com/uploads/sin_imagen_d36205f0e8.png";

          html += `<li class="evento">
            <div class="fila">
              <span class="hora">${hora}</span>
              <img class="bandera" src="${logo}" alt="">
              <span class="nombre">${nombre}</span>
            </div>
            <div class="servidores">`;

          const embeds = attr.embeds?.data || [];
          if (embeds.length > 0) {
            embeds.forEach(embed => {
              const nombreCanal = embed.attributes?.embed_name || "Canal";
              let url = (embed.attributes?.embed_iframe || "").trim();

              // Si es ruta relativa, la dejamos así para codificar
              if (url && !url.startsWith("http")) {
                // No la conviertas en URL absoluta aquí: la procesará tu reproductor
              }

              if (url) {
                const cod = btoa(url);
                html += `<a href="/embed/reproductor.html?r=${encodeURIComponent(cod)}&hora=${encodeURIComponent(hora)}&nombre=${encodeURIComponent(nombre)}" target="_blank" class="canal">➤ ${nombreCanal}</a>`;
              }
            });
          } else {
            html += `<span style="color:#888;padding-left:40px;">Próximamente...</span>`;
          }

          html += `</div></li>`;
        });

        cont.innerHTML = html;
      } catch (e) {
        cont.innerHTML = "<li style='color:red;'>Error al cargar la agenda.</li>";
        console.error(e);
      }
    }
  </script>
</body>
</html>
