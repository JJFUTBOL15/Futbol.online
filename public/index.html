<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agenda Combinada - JJFUTBOL</title>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 15px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .fuente-titulo {
      padding: 10px 16px;
      background: #34495e;
      color: white;
      font-size: 1.1em;
      font-weight: bold;
    }
    #title-agenda {
      text-align: center;
      padding: 16px;
      background: #e74c3c;
      color: white;
      margin: 0;
      font-size: 1.4em;
    }
    #menu {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #menu li {
      border-bottom: 1px solid #eee;
    }
    #menu li > div {
      display: flex;
      align-items: center;
      padding: 14px;
      cursor: pointer;
    }
    #menu time {
      width: 60px;
      font-weight: bold;
      color: #e74c3c;
    }
    #menu .flag {
      width: 24px;
      height: 24px;
      margin: 0 10px;
      border-radius: 50%;
    }
    #menu .match {
      flex: 1;
      font-size: 1.05em;
    }
    #menu ul {
      list-style: none;
      padding: 0 14px 14px 74px;
      margin: 0;
      display: none;
    }
    .submenu-item {
      display: block;
      padding: 6px 0;
      color: #3498db;
      text-decoration: none;
      font-weight: bold;
    }
    .submenu-item:hover {
      color: #e74c3c;
    }
    .loading {
      padding: 20px;
      text-align: center;
      color: #777;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="title-agenda">Agenda - Cargando...</h1>
    <ul id="menu"></ul>
  </div>

  <script>
    const FUENTES = [
      {
        url: "https://a.ftvhd.com/diaries.json",
        imgBase: "https://img.futbolonlinehd.com",
        siteBase: "https://jjfutbol.lat",
        nombre: "HDV"
      },
      {
        url: "https://golazoplay.com/agenda.json?v=1.0",
        imgBase: "https://img.golazoplay.com",
        siteBase: "https://jjfutbol.lat",
        nombre: "GolazoPlay"
      }
    ];

    document.addEventListener("DOMContentLoaded", function () {
      cargarAgendasCombinadas();
      $(document).on("click", ".submenu-item", function (e) { e.stopPropagation(); });
      $(document).on("click", ".toggle-submenu", function () {
        const $submenu = $(this).closest("li").find("ul");
        if (!$submenu.is(":visible")) {
          $(".toggle-submenu").not(this).closest("li").find("ul").slideUp();
          $submenu.slideDown();
        } else {
          $submenu.slideUp();
        }
      });
      setInterval(cargarAgendasCombinadas, 60000);
    });

    function convertToUserTimeZone(utcHour) {
      if (!utcHour) return "--:--";
      try {
        const clean = utcHour.split(':').slice(0, 2).join(':');
        const dt = luxon.DateTime.fromFormat(clean, "HH:mm", { zone: "America/Lima" });
        return dt.toLocal().toFormat("HH:mm");
      } catch (e) {
        return "--:--";
      }
    }

    function formatDateSpanish(dateStr) {
      const [y, m, d] = (dateStr || "").split("-").map(Number);
      if (!y || !m || !d) return null;
      const dt = new Date(y, m - 1, d);
      return dt.toLocaleDateString("es-ES", { year: "numeric", month: "long", day: "numeric" });
    }

    function extraerFechaMasComun(result) {
      const arr = (result && result.data) ? result.data : [];
      const dates = arr.map(it => it?.attributes?.date_diary).filter(Boolean);
      if (dates.length === 0) return null;
      const counts = {};
      let best = dates[0], max = 0;
      for (const d of dates) {
        counts[d] = (counts[d] || 0) + 1;
        if (counts[d] > max) { max = counts[d]; best = d; }
      }
      return best;
    }

    function obtenerTitulo(result) {
      const dd = extraerFechaMasComun(result);
      return dd ? formatDateSpanish(dd) : new Date().toLocaleDateString("es-ES");
    }

    function extraerParametroR(urlRelativa) {
      try {
        const partes = urlRelativa.split('?');
        if (partes.length > 1) {
          const params = new URLSearchParams(partes[1]);
          return params.get("r");
        }
      } catch (e) {
        console.warn("Error extrayendo parámetro r:", urlRelativa);
      }
      return null;
    }

    async function procesarFuente(fuente, menuHtml) {
      try {
        const res = await fetch(fuente.url + "?t=" + Date.now());
        const result = await res.json();
        if (!result?.data?.length) return menuHtml;

        const titulo = obtenerTitulo(result);
        menuHtml += `<li><div class="fuente-titulo">Fuente: ${fuente.nombre} — ${titulo}</div></li>`;

        result.data.sort((a, b) => {
          const A = (a.attributes?.date_diary || "") + (a.attributes?.diary_hour || "");
          const B = (b.attributes?.date_diary || "") + (b.attributes?.diary_hour || "");
          return A.localeCompare(B);
        });

        result.data.forEach(item => {
          const attr = item.attributes || {};
          const hora = convertToUserTimeZone(attr.diary_hour);
          const nombre = attr.diary_description || "Evento sin título";
          const flagUrl = attr.country?.data?.attributes?.image?.data?.attributes?.url;
          const imageUrl = flagUrl ? fuente.imgBase + flagUrl : fuente.imgBase + "/uploads/sin_imagen_d36205f0e8.png";

          let canalesHtml = '<ul style="display:none;">';
          const embeds = attr.embeds?.data || [];
          if (embeds.length > 0) {
            embeds.forEach(embed => {
              if (!embed?.attributes) return;
              const nombreCanal = embed.attributes.embed_name || "Ver enlace";
              const urlRelativa = (embed.attributes.embed_iframe || "").trim();
              let urlFinal = "#";

              // Intentar extraer parámetro "r" (como en GolazoPlay)
              const r = extraerParametroR(urlRelativa);
              if (r) {
                urlFinal = `${fuente.siteBase}/embed/eventos.html?r=${encodeURIComponent(r)}`;
              } else if (urlRelativa.startsWith("/")) {
                // Si no hay "r", tratar como ruta relativa (como en HDV)
                urlFinal = fuente.siteBase + urlRelativa;
              } else if (urlRelativa.startsWith("http")) {
                urlFinal = urlRelativa;
              }

              canalesHtml += `
                <li class="submenu">
                  <a href="${urlFinal}" class="submenu-item" target="_blank">
                    <i class="fa fa-play-circle"></i> ${nombreCanal}
                  </a>
                </li>`;
            });
          } else {
            canalesHtml += `<li class="submenu"><span class="submenu-item" style="color:#999;">Próximamente...</span></li>`;
          }
          canalesHtml += '</ul>';

          menuHtml += `
            <li class="toggle-submenu">
              <div>
                <time>${hora}</time>
                <img class="flag" src="${imageUrl}" alt="Bandera">
                <span class="match">${nombre}</span>
              </div>
              ${canalesHtml}
            </li>`;
        });
      } catch (e) {
        console.error(`Error en fuente ${fuente.nombre}:`, e);
      }
      return menuHtml;
    }

    async function cargarAgendasCombinadas() {
      const menu = document.getElementById("menu");
      menu.innerHTML = '<li><div class="loading">Cargando HDV y GolazoPlay...</div></li>';

      let menuHtml = "";
      for (const fuente of FUENTES) {
        menuHtml = await procesarFuente(fuente, menuHtml);
      }

      menu.innerHTML = menuHtml || '<li><div class="loading" style="color:red;">No se pudo cargar ninguna agenda.</div></li>';

      // Actualizar título principal
      document.getElementById("title-agenda").textContent = "Agenda - " + new Date().toLocaleDateString("es-ES", {
        year: "numeric", month: "long", day: "numeric"
      });
    }
  </script>
</body>
</html>
